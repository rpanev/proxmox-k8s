# {{ ansible_managed }}
# TCP/UDP proxy and load balancing block for K3s API
stream {
    upstream k3s_servers {
{% for host in groups['master'] %}
        server {{ hostvars[host]['ansible_host'] }}:6443 max_fails=3 fail_timeout=30s;  # {{ host }}
{% endfor %}
    }
    
    server {
        listen 6443;
        proxy_pass k3s_servers;
        proxy_timeout 30s;
        proxy_connect_timeout 2s;
    }
}
